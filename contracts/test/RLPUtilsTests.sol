// (c) 2024, Ava Labs, Inc. All rights reserved.
// See the file LICENSE for licensing terms.

// SPDX-License-Identifier: Ecosystem

pragma solidity 0.8.18;

import {Test} from "forge-std/Test.sol";
import {RLPUtils} from "../src/RLPUtils.sol";
import {RLPReader} from "@solidity-merkle-trees/trie/ethereum/RlpReader.sol";
import {EVMReceipt} from "../src/IEventImporter.sol";

contract PriceFeedImporterTest is Test {
    using RLPReader for bytes;

    function testDecodeLegacyReceipt() public {
        bytes[] memory encodedReceipts = new bytes[](4);
        encodedReceipts[0] =
            hex"f901a70183040d64b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010001000000000000000000000000000000000000000008000020000000000080000000000000000000000000000000000008000000000000000000000000000000000000000010000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000002000000040000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000f89df89b949702230a8ea53601f5cd2dc00fdbc13d4df4a8c7f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa00000000000000000000000000d0707963952f2fba59dd06f2b425ace40b492fea0000000000000000000000000adaa262e0f1d9689f1e08d729c8c1f8706d1db40a00000000000000000000000000000000000000000000000000000000008fe8d20";
        encodedReceipts[1] =
            hex"f901a7018304fc36b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000020000000000080000000000000000000000000000000000008000000000000000000000000000000000000000010000000000000000000000000000000000000000000020010000000000000000000000000000000000000000000000000002000000000080000000000000000000000000000000002000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000f89df89b949702230a8ea53601f5cd2dc00fdbc13d4df4a8c7f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa00000000000000000000000000d0707963952f2fba59dd06f2b425ace40b492fea0000000000000000000000000ca71e9eadacaceadec0f0f7d6e405bd475f0b4ada0000000000000000000000000000000000000000000000000000000005358de47";
        encodedReceipts[2] =
            hex"f90c7e0183098674b9010000000000000000000000000000000001200000040000800000040000000000080000000000000000000000000008000008400000000000000020020000080000000000000000000004002008000000000008000000000000000000000000000000210000001000000000000000000000000000000000080000000010000000000800000000000000000000000000000000000000000000000020000000000000000000000008000001000000000000120000100000000000800000800000000000000002000400000000000000000010000000000000002000000020000000000000000000000080000000000000000000000000000000000000000000000000f90b73f89b94b97ef9ef8734c71904d8002f8b6bc66dd9c48a6ef863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa000000000000000000000000060c63d3f8f6abd0b17c7ad6f32f8245ed3492dd7a00000000000000000000000006f0f6393e45fe0e7215906b6f9cfeff53ea139cfa0000000000000000000000000000000000000000000000000000000005a687ef8f89b94b97ef9ef8734c71904d8002f8b6bc66dd9c48a6ef863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa00000000000000000000000006f0f6393e45fe0e7215906b6f9cfeff53ea139cfa0000000000000000000000000e75c7e85fe6add07077467064ad15847e6ba9877a0000000000000000000000000000000000000000000000000000000005a687ef8f9089a94292fc50e4eb66c3f6514b9e402dbc25961824d62e1a0532dbb6d061eee97ab4370060f60ede10b3dc361cc1214c07ae5e34dd86e6aafb90860000000000000000000000000292fc50e4eb66c3f6514b9e402dbc25961824d6200000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000b8f275fbf7a959f4bce59999a2ef122a099e81a80000000000000000000000005523985926aa12ba58dc5ad00ddca99678d7227e000000000000000000000000000000000000000000000000000000000000dbe00000000000000000000000000000000000000000000000000000000000000784c29a91bc000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000493e0000000000000000000000000000000000000000000000000000000005a687ef8a238e56b55cfcc5cfd772214c7a2ba7efbcb8cee432cf1db9b37df3d7523791c83625795b465bd132083714222e28a09b2e21243647e35d2f81f4061b12ca31b000000000000000000000000b97ef9ef8734c71904d8002f8b6bc66dd9c48a6e000000000000000000000000000000000000000000000000000000000000a86a00000000000000000000000060c63d3f8f6abd0b17c7ad6f32f8245ed3492dd700000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000cb28fbe3e9c0fea62e0e63ff3f232cecfe555ad40000000000000000000000000000000000000000000000000000000000000200000000000000000000000000b8f275fbf7a959f4bce59999a2ef122a099e81a800000000000000000000000000000000000000000000000000000000000005200000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000000200000000000000000000000004967f713aca02039ea18c2e5805a863b5ec25a0000000000000000000000000eeae2132f2e21f68d862c535d7d9857803fbcf3f00000000000000000000000000000000000000000000000000000000000002e41e859a05000000000000000000000000000000000000000000000000000000005a687ef800000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000002cbabd7329b84e2c0a317702410e7c73d0e0246d0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c48f6bdeaa00000000000000000000000000000000000000000000000000000000000000110000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000005a63eb180000000000000000000000000000000000000000000000000000000059e46c2d000000000000000000000000cb28fbe3e9c0fea62e0e63ff3f232cecfe555ad400000000000000000000000000000000000000000000000000000000664e68d80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006148fd6c649866596c3d8a971fc313e5ece84882000000000000000000000000000000000000000000000000000000000000000200000000000000000000000004967f713aca02039ea18c2e5805a863b5ec25a0000000000000000000000000eeae2132f2e21f68d862c535d7d9857803fbcf3f00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000204e66bb550000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000493e0000000000000000000000000000000000000000000000000000000005a58101900000000000000000000000000000000000000000000000000000000000000000000000000000000000000002cbabd7329b84e2c0a317702410e7c73d0e0246d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000eeae2132f2e21f68d862c535d7d9857803fbcf3f00000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060c63d3f8f6abd0b17c7ad6f32f8245ed3492dd700000000000000000000000001a3c8e513b758ebb011f7afaf6c37616c9c24d90000000000000000000000005523985926aa12ba58dc5ad00ddca99678d7227e00000000000000000000000060c63d3f8f6abd0b17c7ad6f32f8245ed3492dd7000000000000000000000000000000000000000000000000000000000000a4b173796d62696f7369732d6170700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f9011d94e75c7e85fe6add07077467064ad15847e6ba9877f884a031325fe0a1a2e6a5b1e41572156ba5b4e94f0fae7e7f63ec21e9b5ce1e4b3eaba000000000000000000000000060c63d3f8f6abd0b17c7ad6f32f8245ed3492dd7a0000000000000000000000000000000000000000000000000000000000000dbe0a000000000000000000000000060c63d3f8f6abd0b17c7ad6f32f8245ed3492dd7b880a238e56b55cfcc5cfd772214c7a2ba7efbcb8cee432cf1db9b37df3d7523791c00000000000000000000000060c63d3f8f6abd0b17c7ad6f32f8245ed3492dd7000000000000000000000000000000000000000000000000000000005a687ef8000000000000000000000000b97ef9ef8734c71904d8002f8b6bc66dd9c48a6ef87a94e75c7e85fe6add07077467064ad15847e6ba9877f842a05a297b2c9a9f94a0f4e5a796c74ad38e219d1185fccf5f79c18726a830c2b6f5a073796d62696f7369732d61707000000000000000000000000000000000000000a0a238e56b55cfcc5cfd772214c7a2ba7efbcb8cee432cf1db9b37df3d7523791c";
        encodedReceipts[3] =
            hex"f905a40183162ae9b9010000000000000000000000000000000000000000000000000000000100000000000000100000000000000000000000000000000000000200000000000000000000000000000000000000000001002000000000000001000000000000000000000000000000020000000000000000000800000000000000000000000000000001000000000000000000000000000000000000000480000000000000000000400000000000001000000000000200000000000000000008000008000000000000000000000000000000000000000000000000004010000000000000000000000020000000000000000000000000000000000000000000000000000000000001000000f90499f9035c94154bab1fc1d87ff641eed0e9bc0f8a50d880d2b6f842a0f6a97944f31ea060dfde0566e4167c1a1082551e64b60ecb14d599a9d023d451a0000000000000000000000000000000000000000000000000000000000002be00b90300000000000000000000000000000000000000000000000000000006010e05e000000000000000000000000000e5b37dc608c73852f9c0f56e30f8d74d89b51c5500000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000f4fc72042f23c3a2b6da6ebfecf0b6e30001538902000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000600bc7bda0000000000000000000000000000000000000000000000000000000600bc8b1c4000000000000000000000000000000000000000000000000000000600c0b0c17000000000000000000000000000000000000000000000000000000600d9b39e5000000000000000000000000000000000000000000000000000000600f2e28c6000000000000000000000000000000000000000000000000000000600f9c1e30000000000000000000000000000000000000000000000000000000600f9c1e3000000000000000000000000000000000000000000000000000000060105dd20a8000000000000000000000000000000000000000000000000000006010e05e000000000000000000000000000000000000000000000000000000006010e05e000000000000000000000000000000000000000000000000000000006010e05e000000000000000000000000000000000000000000000000000000006013c1415ba000000000000000000000000000000000000000000000000000006014367c00800000000000000000000000000000000000000000000000000000601bf96ddf600000000000000000000000000000000000000000000000000000601bf96ddf6000000000000000000000000000000000000000000000000000006023b6e36e00000000000000000000000000000000000000000000000000000000000000010010f0d0e0c040903080a000b0607020500000000000000000000000000000000f89b94154bab1fc1d87ff641eed0e9bc0f8a50d880d2b6f863a00109fc6f55cf40689f02fbaad7af7fe7bbac8a3d2186600afc7d3e10cac60271a0000000000000000000000000000000000000000000000000000000000002be00a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000066452e8df89b94154bab1fc1d87ff641eed0e9bc0f8a50d880d2b6f863a00559884fd3a460db3073b7fc896cc77986f16e378210ded43186175bf646fc5fa0000000000000000000000000000000000000000000000000000006010e05e000a0000000000000000000000000000000000000000000000000000000000002be00a00000000000000000000000000000000000000000000000000000000066452e8d";

        // Loop through the encoded receipts and decode them.
        for (uint256 i = 0; i < encodedReceipts.length; i++) {
            EVMReceipt memory res = RLPUtils.decodeReceipt(encodedReceipts[i].toRlpItem());
            assertEq(res.txType, 0);
        }
    }

    function testDecodeDynamicFeeReceipt() public {
        bytes[] memory encodedReceipts = new bytes[](4);
        encodedReceipts[0] =
            hex"02f90109808302728cb9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0";
        encodedReceipts[1] =
            hex"02f901a70183031e92b9010000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000008000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000010000000000000000400000000000000000000000000000010000000010000000000000000000000000000000000000000000000000000000000008000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000020000000000000000f89df89b949702230a8ea53601f5cd2dc00fdbc13d4df4a8c7f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000caf3fc115114d5b79a7388b2836bf90a69eb3d85a00000000000000000000000007e4aa755550152a522d9578621ea22edab204308a00000000000000000000000000000000000000000000000000000000011f0e540";
        encodedReceipts[2] =
            hex"02f9010901830a1552b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0";
        encodedReceipts[3] =
            hex"02f909520183107679b90100000000000000000000000000001000200002000000000000210000000000000000004000000000400050040020081000000000000000000200000802000000000080c0000004000000800008004000000000000000000000000010008002080000000011000000000000000100000800000000400000002000000010000004010000000000000000000010010000000002000000000000000000000800000000000000000000000400000000000000000000000000000000000000000400000000000002000000000000000001000000000000000000000000000004000000000000000000000000000100000000400000020000000000000000000000000000f90847f89b94b31f66aa3c1e785363f0875a1b74e27b85fd66c7f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa00000000000000000000000002939df25c6818c5b5bbd35a3f29daccc52e81b34a000000000000000000000000034552ffe55e32067a75800a75fb59e0c35112e33a00000000000000000000000000000000000000000000000166177380000000000f89b94b31f66aa3c1e785363f0875a1b74e27b85fd66c7f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa000000000000000000000000034552ffe55e32067a75800a75fb59e0c35112e33a0000000000000000000000000ed9e3f98bbed560e66b89aac922e29d4596a9642a00000000000000000000000000000000000000000000000166177380000000000f89b94152b9d0fdc40c096757f570a51e494bd4b943e50f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000ed9e3f98bbed560e66b89aac922e29d4596a9642a0000000000000000000000000d9fa522f5bc6cfa40211944f2c8da785773ad99da00000000000000000000000000000000000000000000000000000000001499134f9015d94ed9e3f98bbed560e66b89aac922e29d4596a9642f884a00e8e403c2d36126272b08c75823e988381d9dc47f2f0a9a080d95f891d95c469a0000000000000000000000000b31f66aa3c1e785363f0875a1b74e27b85fd66c7a0000000000000000000000000152b9d0fdc40c096757f570a51e494bd4b943e50a0000000000000000000000000d9fa522f5bc6cfa40211944f2c8da785773ad99db8c00000000000000000000000000000000000000000000000166177380000000000000000000000000000000000000000000000000000000000000000000149913400000000000000000000000034552ffe55e32067a75800a75fb59e0c35112e3300000000000000000000000077746168d153649d6305e59409ad8f470000000000000000000000000000000000000000000000000000000000000003508622550000000000000000000000000000000000000000000000000000000000364e37f9013c94d9fa522f5bc6cfa40211944f2c8da785773ad99df863a0ad7d6f97abf51ce18e17a38f4d70e975be9c0708474987bb3e26ad21bd93ca70a000000000000000000000000034552ffe55e32067a75800a75fb59e0c35112e33a000000000000000000000000034552ffe55e32067a75800a75fb59e0c35112e33b8c0000000000000000000000000000000000000000000000000000000000080778600000000000000000000000000000000000000000000000000000000014988c1000000000000001662c2ada7f08bf33b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004e200000000000000000000000000000000000000000000000000000000000054600000000000000000000000000000000000000000000000000000000000000870f9013c94d9fa522f5bc6cfa40211944f2c8da785773ad99df863a0ad7d6f97abf51ce18e17a38f4d70e975be9c0708474987bb3e26ad21bd93ca70a000000000000000000000000034552ffe55e32067a75800a75fb59e0c35112e33a000000000000000000000000034552ffe55e32067a75800a75fb59e0c35112e33b8c0000000000000000000000000000000000000000000000000000000000080778500000000000000000000000000000000000000000000000000000000000000030000000000000000000022c70c92a92a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002bf200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000f89b94b31f66aa3c1e785363f0875a1b74e27b85fd66c7f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000d9fa522f5bc6cfa40211944f2c8da785773ad99da000000000000000000000000034552ffe55e32067a75800a75fb59e0c35112e33a000000000000000000000000000000000000000000000001662c2d06efd1e9c65f89b94b31f66aa3c1e785363f0875a1b74e27b85fd66c7f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa000000000000000000000000034552ffe55e32067a75800a75fb59e0c35112e33a00000000000000000000000002939df25c6818c5b5bbd35a3f29daccc52e81b34a00000000000000000000000000000000000000000000000166177380000000000f8b9942939df25c6818c5b5bbd35a3f29daccc52e81b34e1a00b82e93068db15abd9fbb2682c65462ea8a0a10582dce93a5664818e296f54ebb88000000000000000000000000034552ffe55e32067a75800a75fb59e0c35112e3300000000000000000000000034552ffe55e32067a75800a75fb59e0c35112e3300000000000000000000000000000000000000000000001661773800000000000000000000000000000000000000000000000000000000000000000000000000f89b94b31f66aa3c1e785363f0875a1b74e27b85fd66c7f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa000000000000000000000000034552ffe55e32067a75800a75fb59e0c35112e33a000000000000000000000000077746168d153649d6305e59409ad8f4700000000a0000000000000000000000000000000000000000000000000014b986efdefaf76";

        // Loop through the encoded receipts and decode them.
        for (uint256 i = 0; i < encodedReceipts.length; i++) {
            EVMReceipt memory res = RLPUtils.decodeReceipt(encodedReceipts[i].toRlpItem());
            assertEq(res.txType, 2);
        }
    }
}
